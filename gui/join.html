<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>SyBim</title>
  <link rel="stylesheet" type="text/css" href="/static/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/site.webmanifest">
</head>

<body>
  <div class="center-screen">
		<h1>&#127910; <a href="/">SyBim</a></h1>
    <p><strong>Join</strong> room <span id="room_name">abcdef</span></p>

    <form style="text-align: left">
      <label for="name">Nickname:</label><br>
      <input type="text" id="name_input" name="name" style="width: 300px; margin-bottom: 1rem;"><br>

      <div id="password_div" style="display: none;">
        <label for="password_input">Password:</label><br>
        <input type="text" id="password_input" name="password"
               style="width: 300px; margin-bottom: 1rem;">
      </div>

      <button id="join_button" disabled>...</button>
    </form>

    <div class="footer">
      <span style="float: left; margin-left: 1rem">&copy; 2020 hgminh. All right reserved.</span>
      <a id="buy-coffee-link" style="margin-right: 0.5rem"
          href="https://www.buymeacoffee.com/hgminh" target="_blank">
        <strong class="buy_coffee">Buy Me A &#9749;</strong>
      </a>
      <a style="margin-right: 1rem" href="/faq/"><strong>FAQ</strong></a>
    </div>
  </div>
  <div id="toast"></div>

  <script src="/static/base.js"></script>

  <script>
    let prevNickname = localStorage.getItem('nickname');
    if (prevNickname != null)
      $('name_input').value = prevNickname;

    let room = window.location.pathname.split('/').pop();
    $("room_name").innerHTML = room;

    request_ws(`qr:${room}`, msg => {
      if (msg == ":") {
        toast(`Room ${room} does not exist`);
        $("join_button").innerHTML = "Invalid Room";
        return;
      }

      let tokens = msg.split(':');

      if (tokens.length != 2) {
        toast(`Unknown server response. You can try to refresh the page.`);
        $("join_button").innerHTML = "Unknown Response";
        return;
      }

      if (tokens[1] === '*') {
        $('password_div').style.display = "block";
      } else {
        $('password_input').value = "_";
      }

      $('join_button').disabled = false;
      $('join_button').innerHTML = "Join";
    }, error => {
      toast('Cannot connect to server');
      $("join_button").innerHTML = "Cannot Connect";
    });

    $('join_button').onclick = e => {
      e.preventDefault();

      let password = $('password_input').value;

      if (password.length == 0) {
        toast('Password is empty')
        return;
      }

      request_ws(`ar:${room}:${password}`, msg => {
        if (msg === 'x') {
          toast('Access denied. Password is wrong.');
        } else {
          localStorage.setItem('token', msg);
          localStorage.setItem('nickname', $('name_input').value);

          window.location.href = `/r/${room}`;
        }
      }, err => {
      });
    }
  </script>
</body>

</html>
