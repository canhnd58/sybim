<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>SyBim</title>
  <link rel="stylesheet" type="text/css" href="/static/main.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/site.webmanifest">

  <link href="/static/third_party/video-js.css" rel="stylesheet" />
</head>

<body>
  <div id="reconnect-overlay">
    <div class="center-screen">
      <div class="loader"></div>
      <h2 style="color: white">Connecting...</h2>
    </div>
  </div>

  <div class="row">
    <div class="video-container">
      <div id="help-overlay">
        <div class="center-screen" style="color: white">
          <div id="owner-help-text" style="width: 40%; display: none">
            <h3>&#128079; You are the owner of the room</h3>
            <p style="text-align: left">
              Select the video you want to watch in the right side bar.
              You can play, pause, or seek to certain time in the video; and these actions
              will be applied to all other members of the room.
            </p>
          </div>

          <div id="member-help-text" style="width: 40%; display: none">
            <h3>&#128079; You have joined the room</h3>
            <p style="text-align: left">
              Select the same video as the owner's in the right side bar. You cannot control
              the video player. Just wait for the owner to start and enjoy watching.
            </p>
          </div>

          <div id="invalid-video-help-text" style="width: 40%; display: none">
            <h3>&#128549; Unsupported video type</h3>
            <div style="text-align: left">
              </p>
                The video cannot be played by the browser.
                Please convert the file to appropriate format.
              </p>
              <strong><u>For Linux:</u></strong>
              <p>Run following command in terminal
                <pre>$ ffmpeg -vcodec copy -acodec aac -ac 2 -ab 128k -i &lt;input_file&gt; &lt;output_file&gt;</pre>
              </p>
              <strong><u>For Windows:</u></strong>
              <p>Use this <a href="/static/SybimVideoConverter.exe" style="color: white">small utility</a> to convert your video file.</p>
            </div>
          </div>
        </div>
      </div>

      <video-js id="video-player" class="vjs-default-skin vjs-big-play-centered">
      </video-js>
    </div>

    <h2 id="sidebar-open-btn" class="icon"
        style="cursor: pointer; position: absolute; top: 0; right: 1rem; display: none; color: white; z-index: 4">
      &#9776;
    </h2>
    <div id="sidebar" class="sidebar">
      <h2>
        &#127910; <a href="/">SyBim</a>
        <span id="sidebar-close-btn" class="icon" style="float: right; cursor: pointer">
          &#x25B6;
        </span>
      </h2>
      <hr style="width: 100%"/>

      <p id="connect-success-msg">
        <strong>&#128994; Room: </strong><span id="room-text"></span></span>.
        <strong id="user-count-text">0</strong> people in this room.
      </p>

      <p style="margin-bottom: 0px; margin-top: 0px;"><strong>Invite Others?</strong> Use the link belows:</p>
      <p style="margin-bottom: 0.5rem; margin-top: 1rem;" class="monospace">
        <input id="room-link-share" value="https://sybim.live/r/example" readonly/>
        <span id="copy-link-btn" class="icon" style="position: relative; top: -.25em; left: -.125em; cursor: pointer">
          &#128196;<span style="position: absolute; top: .25em; left: .25em">&#128196;</span>
        </span>
      </p>

      <hr style="width: 100%"/>

      <p style="margin-top: 0px"><strong>Video</strong></p>
      <input id="video-input" type="file" accept="video/*" style="min-height: 25px"/>

      <p><strong>Subtitles</strong></p>
      <input id="subtitle-input" type="file" accept=".vtt,.srt" style="min-height: 25px"/>

      <hr style="width: 100%; margin-top: 1rem;"/>

      <p id="help-text" style="margin-bottom: 0px;">
      </p>
      <p><strong><span class="icon">&#128161;</span> <u>Feel like talking?</u></strong> Use whatever chat apps you prefer.</p>

      <hr style="width: 100%"/>
      <p>
        <strong><span class="icon">&#129299;</span> Logs</strong>
        <span id="clear-log-btn" class="icon" style="float:right; cursor:pointer;">&#x29B8;<span>
      </p>
      <pre id="logger" style="margin-top: 0px"/>
    </div>
  </div>
  <div id="toast"></div>

  <script src="/static/third_party/srt_webvtt.js"></script>
  <script src="/static/third_party/spark-md5.min.js"></script>
  <script src="/static/third_party/video.js"></script>
  <script src="/static/base.js"></script>
  <script>
    /* Taken from video.js source code */

    /**
     * Returns whether an object is `Promise`-like (i.e. has a `then` method).
     *
     * @param  {Object}  value
     *         An object that may or may not be `Promise`-like.
     *
     * @return {boolean}
     *         Whether or not the object is `Promise`-like.
     */
    function isPromise(value) {
      return value !== undefined && value !== null && typeof value.then === 'function';
    }
    
    /**
     * Silence a Promise-like object.
     *
     * This is useful for avoiding non-harmful, but potentially confusing "uncaught
     * play promise" rejection error messages.
     *
     * @param  {Object} value
     *         An object that may or may not be `Promise`-like.
     */
    function silencePromise(value) {
      if (isPromise(value)) {
        value.then(null, (e) => {});
      }
    }

    function isSingleLeftClick(event) {
      // Note: if you create something draggable, be sure to
      // call it on both `mousedown` and `mousemove` event,
      // otherwise `mousedown` should be enough for a button
    
      if (event.button === undefined && event.buttons === undefined) {
        // Why do we need `buttons` ?
        // Because, middle mouse sometimes have this:
        // e.button === 0 and e.buttons === 4
        // Furthermore, we want to prevent combination click, something like
        // HOLD middlemouse then left click, that would be
        // e.button === 0, e.buttons === 5
        // just `button` is not gonna work
    
        // Alright, then what this block does ?
        // this is for chrome `simulate mobile devices`
        // I want to support this as well
    
        return true;
      }
    
      if (event.button === 0 && event.buttons === undefined) {
        // Touch screen, sometimes on some specific device, `buttons`
        // doesn't have anything (safari on ios, blackberry...)
    
        return true;
      }
    
      // `mouseup` event on a single left click has
      // `button` and `buttons` equal to 0
      if (event.type === 'mouseup' && event.button === 0 &&
          event.buttons === 0) {
        return true;
      }
    
      if (event.button !== 0 || event.buttons !== 1) {
        // This is the reason we have those if else block above
        // if any special case we can catch and let it slide
        // we do it above, when get to here, this definitely
        // is-not-left-click
    
        return false;
      }
    
      return true;
    } 

    /* Silly hack to disable the click to play event */
    let PlayerComponent = videojs.getComponent('Player');
    PlayerComponent.prototype.handleTechClick_ = function(event) {
      if (!isSingleLeftClick(event)) {
        return;
      }

      // When controls are disabled a click should not toggle playback because
      // the click is considered a control
      if (!this.controls_ || !this.isOwner) {
        return;
      }

      if (this.paused()) {
        silencePromise(this.play());
      } else {
        this.pause();
      }
    };
  </script>
  <script>
    let hashCounter = 0;
    function calculateMD5Hash(file, onFinish) {
      hashCounter += 1;
      let thisHashCounter = hashCounter;
			let blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
          chunkSize = 2097152, // read in chunks of 2MB
          chunks = Math.ceil(file.size / chunkSize),
          currentChunk = 0,
          spark = new SparkMD5.ArrayBuffer(),
          frOnload = function(e){
            spark.append(e.target.result); // append array buffer
            currentChunk++;
            if (currentChunk < chunks)
              loadNext();
            else if (thisHashCounter === hashCounter) // ignore old runs
              onFinish(spark.end());
					},
          frOnerror = function () {};
      function loadNext() {
        let fileReader = new FileReader();
        fileReader.onload = frOnload;
        fileReader.onerror = frOnerror;
        let start = currentChunk * chunkSize,
        end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;
        fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
      };

      loadNext();
    }
  </script>
  <script>
    let logger = $("logger");
    logger.innerHTML = '';

    function toLogStr(message) {
      if (typeof message === 'object') {
        return JSON && JSON.stringify ? JSON.stringify(message) : message;
      } else {
        return message;
      }
    }

    function log(message) {
      logger.innerHTML += '<span>' + toLogStr(message) + '</span><br/>';
      logger.scrollTop = logger.scrollHeight;
    }

    function logError(message) {
      logger.innerHTML += '<span class="error">' + toLogStr(message) + '</span><br/>';
      logger.scrollTop = logger.scrollHeight;
    }

    function logSuccess(message) {
      logger.innerHTML += '<span class="success">' + toLogStr(message) + '</span><br/>';
      logger.scrollTop = logger.scrollHeight;
    }

    function clearLogs() {
      logger.innerHTML = '';
    }

    function toHHMMSS(seconds) {
      let hh = Math.floor(seconds / (60 * 60));
      let mm = Math.floor((seconds / 60) % 60);
      let ss = Math.floor(seconds % 60);

      if (hh > 0)
        return `${hh > 9 ? '' : '0'}${hh}:${mm > 9 ? '' : '0'}${mm}:${ss > 9 ? '' : '0'}${ss}`;
      else
        return `${mm > 9 ? '' : '0'}${mm}:${ss > 9 ? '' : '0'}${ss}`;
    }
  </script>
  <script>
    var helpController = {
      hide() {
        $('help-overlay').style.display = 'none';
      },

      showOwnerHelp(overlay = true) {
        $('owner-help-text').style.display = 'block';
        $('member-help-text').style.display = 'none';
        $('invalid-video-help-text').style.display = 'none';

        if (overlay)
          $('help-overlay').style.display = 'block';

        $("help-text").innerHTML = '<span class="icon">&#129300;</span> \
            <strong><u>How to distribute the video to others?</u></strong> \
            Use <a href="https://dropbox.com" target="_blank">Dropbox</a>, \
            <a href="https://drive.google.com" target="_blank">Google Drive</a>, etc.';
      },

      showMemberHelp(overlay = true) {
        $('owner-help-text').style.display = 'none';
        $('member-help-text').style.display = 'block';
        $('invalid-video-help-text').style.display = 'none';

        if (overlay)
          $('help-overlay').style.display = 'block';

        $("help-text").innerHTML = '<span class="icon">&#129300;</span> \
            <strong><u>Where is the video?</u></strong> \
            Ask the owner of this room.';
      },

      showInvalidVideoTypeHelp() {
        $('owner-help-text').style.display = 'none';
        $('member-help-text').style.display = 'none';
        $('invalid-video-help-text').style.display = 'block';
        $('help-overlay').style.display = 'block';
      }
    };
  </script>
  <script>
    function getWSAddr() {
      let loc = window.location, new_uri;
      if (loc.protocol === "https:")
        new_uri = "wss:";
      else
        new_uri = "ws:";
      new_uri += "//" + loc.host + "/ws";

      return new_uri;
    }

    class ApplicationController {
      constructor() {
        this.socket = null;
        this.retryTimer = null;
        this.heartbeatTimer = null;
        this.videoPlayer = null;
        this.isOwner = false;
        this.isConnected = false;
        this.room = '';
        this.upstreamHash = '';
        this.localHash = '';
        this.hasVideo = false;
      }

      connectToRoom(room) {
        log(`Connecting to room ${room}...`);
        if (this.room === '') { /* first time connect */
          setTimeout(() => {
            if (!this.isConnected) {
              $("reconnect-overlay").style.display = "block";
            }
          }, 2000);
        }

        this.room = room;
        this.socket = new WebSocket(getWSAddr());
        this.socket.onopen = event => {
          this.isConnected = true;
          logSuccess('Websocket connected');
          $("reconnect-overlay").style.display = "none";
          this.socket.send(`r:j:${room}`);
          this.heartbeatTimer = setInterval(() => this.socket.send("hb"), 15000);
        };

        this.socket.onmessage = event => {
          if (event.data.text) {
            event.data.text().then(msg => this.onMsgRecv(msg));
          } else {
            this.onMsgRecv(event.data);
          }
        }

        this.socket.onerror = event => {
          this.isConnected = false;
          $("reconnect-overlay").style.display = "block";
          logError('Error!!!');

          clearTimeout(this.retryTimer);
          clearInterval(this.heartbeatTimer);
          this.retryTimer = setTimeout(() => this.reconnect(), 5000);
        };

        this.socket.onclose = event => {
          this.isConnected = false;
          $("reconnect-overlay").style.display = "block";
          logError('Connection closed');

          clearTimeout(this.retryTimer);
          clearInterval(this.heartbeatTimer);
          this.retryTimer = setTimeout(() => this.reconnect(), 5000);
        };
      }

      reconnect() {
        this.connectToRoom(this.room);
      }

      onBecomeOwner() {
        logSuccess('You are the owner');
        toast("You are the owner");
        this.isOwner = true;
        this.videoPlayer.isOwner = true;
        helpController.showOwnerHelp(!this.hasVideo);

        let controlBar = this.videoPlayer.getChild('ControlBar');
        controlBar.playToggle.enable();
        controlBar.progressControl.enable();

        let bigPlayButton = this.videoPlayer.getChild('BigPlayButton');
        bigPlayButton.enable();
        bigPlayButton.show();
      }

      onBecomeMember() {
        logSuccess('Joined');
        toast("Joined");
        this.isOwner = false;
        this.videoPlayer.isOwner = false;
        helpController.showMemberHelp(!this.hasVideo);

        let controlBar = this.videoPlayer.getChild('ControlBar');
        controlBar.playToggle.disable();
        controlBar.progressControl.disable();

        let bigPlayButton = this.videoPlayer.getChild('BigPlayButton');
        bigPlayButton.disable();
        bigPlayButton.hide();
      }

      onMsgRecv(msg) {
        if (msg === "hb") {
        } else if (msg === "l:s") {
          logSuccess('Logged on');
        } else if (msg === "r:o") {
          this.isConnected = true;
          this.onBecomeOwner();
        } else if (msg === "r:s") {
          this.onBecomeMember();
        } else {
          if (!this.videoPlayer)
            return;

          let tokens = msg.split(':');
          if (tokens[0] == 'play') {
            log(`Upstream: Play @ ${toHHMMSS(parseFloat(tokens[1]))}`);
            this.videoPlayer.currentTime(parseFloat(tokens[1]));
            this.videoPlayer.play();
          } else if (tokens[0] == 'pause') {
            log(`Upstream: Pause @ ${toHHMMSS(parseFloat(tokens[1]))}`);
            this.videoPlayer.currentTime(parseFloat(tokens[1]));
            this.videoPlayer.pause();
          } else if (tokens[0] == 'seek') {
            this.videoPlayer.currentTime(parseFloat(tokens[1]));
          } else if (tokens[0] == 'hash') {
            this.updateUpstreamHash(tokens[1]);
          } else if (tokens[0] == 'user_count') {
            $('user-count-text').innerHTML = tokens[1];
          } else {
            console.log(tokens[0]);
          }
        }
      }

      onNewURL(url, type) {
        url += "#t=5";
        this.hasVideo = true;

        this.videoPlayer.src({src: url, type: type});
        log(`Changing source to ${url}`);
        this.videoPlayer.ready(() => {
          log('Video player is ready');
          if (this.isOwner) {
            let bigPlayButton = this.videoPlayer.getChild('BigPlayButton');
            bigPlayButton.show();
          } else {
            this.requestStatus();
          }
        });
      }

      attachVideoPlayer(videoPlayer) {
        this.videoPlayer = videoPlayer;
        videoPlayer.on("pause", e => {
          if (!videoPlayer.seeking()) {
            if (this.isOwner) {
              this.socket.send(`c:b:pause:${videoPlayer.currentTime()}`);
            }
            log(`Pause @ ${toHHMMSS(videoPlayer.currentTime())}`);
          }
        });

        videoPlayer.on("play", e => {
          if (this.isOwner) {
            this.socket.send(`c:b:play:${videoPlayer.currentTime()}`);
          }
          log(`Play @ ${toHHMMSS(videoPlayer.currentTime())}`);
        });
      }

      updateLocalHash(md5) {
        this.localHash = md5;
        this.socket.send(`c:h:hash:${md5}`);

        this.compareHash();
      }

      updateUpstreamHash(md5) {
        this.upstreamHash = md5;

        this.compareHash();
      }

      compareHash() {
        if (this.upstreamHash === "" || this.localHash === "" || this.isOwner)
          return;
        if (this.upstreamHash === this.localHash) {
          logSuccess("Video file is good");
          toast("Your video file matches with owner's")
        } else {
          logError("Video does not match with owner");
          toast("Your video file does not match with owner's")
        }
      }

      requestStatus() {
        log('Request current state');
        this.socket.send("c:rs");
      }
    }
  </script>
  <script>
    let room = window.location.pathname.split('/').pop();
    $("room-text").innerHTML = room;
    $("room-link-share").value = window.location.protocol + "//" + window.location.host +
        "/r/" + room;
    $("copy-link-btn").onclick = e => {
      $("room-link-share").select();
      document.execCommand("copy");

      toast('Link Copied');
    }

    let videoPlayer = videojs('video-player', {
      controls: true,
      autoplay: false,
      preload: 'auto',
      children: {
        bigPlayButton: false,
        textTrackDisplay: true,
        controlBar: {
          playToggle: true,
          currentTimeDisplay: true,
          timeDivider: true,
          durationDisplay: true,
          progressControl: true,
          remainingTimeDisplay: true,
          subtitlesButton: true,
          pictureInPictureToggle: false,
        }
      }
    });

    let controller = new ApplicationController;

    controller.connectToRoom(room);
    controller.attachVideoPlayer(videoPlayer);

    $("video-input").onchange = evt => {
      let file = evt.target.files[0];
      let canPlay = videoPlayer.canPlayType(file.type);
      if (canPlay === '' || canPlay === 'no') {
        logError(`Cannot play ${file.type}`);
        toast(`Cannot play selected video`);
        helpController.showInvalidVideoTypeHelp(file.type);
        return;
      } else {
        helpController.hide();
        calculateMD5Hash(file, hash => controller.updateLocalHash(hash));
        controller.onNewURL(URL.createObjectURL(file), file.type);
      }
    }

    $("subtitle-input").onchange = evt => {
      let file = evt.target.files[0];

      const vttConverter = new WebVTTConverter(file);
      vttConverter
          .getURL()
          .then(url => {
            videoPlayer.addRemoteTextTrack({
              kind: 'captions',
              src: url,
              language: 'n/a',
              label: 'default',
            }, false);

            let tracks = videoPlayer.textTracks();
            for (let i = 0; i < tracks.length; i += 1) {
              tracks[i].mode = 'disabled';
            }
            tracks[tracks.length - 1].mode = 'showing';

            toast('New subtitle loaded');
          })
          .catch(err => {
            toast('Failed to load subtitle file');
            console.log('Error: ' + err)
          });
    }

    $("sidebar-close-btn").onclick = evt => {
      $("sidebar").style.display = "none"; 
      $("sidebar-open-btn").style.display = "block"; 
    };
    $("sidebar-open-btn").onclick = evt => {
      $("sidebar").style.display = "flex";
      $("sidebar-open-btn").style.display = "none"; 
    };

    $("clear-log-btn").onclick = evt => {
      clearLogs();
    };
  </script>

</body>

</html>
